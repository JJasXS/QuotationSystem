@page
@model ChatModel
@{
    Layout = null;
    ViewData["Title"] = "Chat Bot";
    var chatTitles = TempData["Chats"] as List<string> ?? new List<string>();
}

<div class="chat-layout">
    <aside class="chat-sidebar">
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <h3 style="margin: 0;">Chats</h3>
            <button type="button" id="openNewChatModal" class="new-chat-btn" title="Add new chat">+</button>
        </div>
        <ul class="chat-list">
            @foreach (var chat in chatTitles)
            {
                <li><a href="#">@chat</a></li>
            }
        </ul>
        <!-- Modal for new chat title -->
        <div id="newChatModal" class="modal" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); align-items:center; justify-content:center;">
            <div style="background:#fff; padding:24px 18px; border-radius:8px; min-width:300px; box-shadow:0 2px 16px #0002;">
                <form method="post" asp-page-handler="AddChat" id="newChatForm">
                    <label for="NewChatTitle" style="font-weight:500;">Chat Title:</label>
                    <input type="text" name="NewChatTitle" id="NewChatTitle" placeholder="Enter chat title..." required style="margin:8px 0; width:100%; padding:6px; border-radius:4px; border:1px solid #ccc;" />
                    <div style="display:flex; gap:8px; justify-content:flex-end;">
                        <button type="button" id="cancelNewChat" style="background:#eee; border:none; border-radius:4px; padding:6px 14px;">Cancel</button>
                        <button type="submit" style="background:#388e3c; color:#fff; border:none; border-radius:4px; padding:6px 14px;">Create</button>
                    </div>
                </form>
            </div>
        </div>
    </aside>
    <main class="chat-main" style="width:100%; position:relative;">
        <div class="chat-tabs-bar" style="display:flex; align-items:center; border-bottom:1.5px solid #ccc; margin-bottom:18px;">
            <div style="flex:1; display:flex; gap:2px;">
                @for (int i = 0; i < chatTitles.Count; i++)
                {
                    <button type="button" class="chat-tab @(i == 0 ? "active" : "")" style="padding:8px 18px; border:none; border-bottom:2.5px solid transparent; background:none; font-size:1em; cursor:pointer; border-radius:8px 8px 0 0; margin-right:2px; font-weight:500; outline:none; transition:background 0.2s;">@chatTitles[i]</button>
                }
            </div>
            <button type="button" id="openNewChatModal" class="new-chat-btn" title="Add new chat" style="margin-left:8px; font-size:1.3em; background:#388e3c; color:#fff; border:none; border-radius:50%; width:32px; height:32px; display:flex; align-items:center; justify-content:center;">+</button>
        </div>
        <!-- Modal for new chat title -->
        <div id="newChatModal" class="modal" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); align-items:center; justify-content:center;">
            <div style="background:#fff; padding:24px 18px; border-radius:8px; min-width:300px; box-shadow:0 2px 16px #0002;">
                <form method="post" asp-page-handler="AddChat" id="newChatForm">
                    <label for="NewChatTitle" style="font-weight:500;">Chat Title:</label>
                    <input type="text" name="NewChatTitle" id="NewChatTitle" placeholder="Enter chat title..." required style="margin:8px 0; width:100%; padding:6px; border-radius:4px; border:1px solid #ccc;" />
                    <div style="display:flex; gap:8px; justify-content:flex-end;">
                        <button type="button" id="cancelNewChat" style="background:#eee; border:none; border-radius:4px; padding:6px 14px;">Cancel</button>
                        <button type="submit" style="background:#388e3c; color:#fff; border:none; border-radius:4px; padding:6px 14px;">Create</button>
                    </div>
                </form>
            </div>
        </div>
        <div class="chat-container">
            <div class="chat-box" id="chatBox">
                <div id="chatContent" style="overflow-y: auto; max-height: 500px; display: flex; flex-direction: column;">
                    @if (Model.Step == "AskSearchMode")
                    {
                        <div class="chat-bubble bot-bubble">Do you want to search by Category (StockGroup) or by Name (Description)?</div>
                        <div class="bot-options" id="dynamicOptions" style="margin-top: 18px; display: flex; flex-wrap: wrap; gap: 10px; justify-content: flex-start;">
                            <button type="button" class="option-btn" onclick="addUserBubble('StockGroup'); showStockGroupOptions();">StockGroup</button>
                            <button type="button" class="option-btn" onclick="addUserBubble('Description'); /* Add your handler for Description here */">Description</button>
                        </div>
                    }
                    @if (!string.IsNullOrEmpty(Model.SelectedMode))
                    {
                        <div class="chat-bubble user-bubble">@Model.SelectedMode</div>
                    }
                    @if (!string.IsNullOrEmpty(Model.SelectedStockGroup))
                    {
                        <div class="chat-bubble user-bubble">@Model.SelectedStockGroup</div>
                    }
                    @if (!string.IsNullOrEmpty(Model.Keyword))
                    {
                        <div class="chat-bubble user-bubble">@Model.Keyword</div>
                    }
                    // ...category selection bubble fully removed...
                    @if (Model.Step == "ShowProducts" && Model.Products?.Count > 0)
                    {
                        <div class="chat-bubble bot-bubble">
                            <div><strong>Bot:</strong> Top matches:</div>
                            <ul class="chat-list">
                                @foreach (var p in Model.Products)
                                {
                                    <li>@p.Code - @p.Description (@p.StockGroup) Price: @(p.StockValue.HasValue ? p.StockValue.Value.ToString("F2") : "not set")</li>
                                }
                            </ul>
                        </div>
                    }
                </div>
            </div>
            <!-- Dynamic options rendering -->
                <div class="bot-options" id="dynamicOptions" style="margin-top: 18px; display: flex; flex-wrap: wrap; gap: 10px; justify-content: flex-start;"></div>
        </div>
        <!-- CSS moved to <style> block below -->
    </main>
</div>

<script>
                // Render chat options in fixed container
                function renderChatOptions(html) {
                    var container = document.getElementById('chatOptionsContainer');
                    if (html && html.trim().length > 0) {
                        container.innerHTML = html;
                        container.style.display = 'flex';
                    } else {
                        container.innerHTML = '';
                        container.style.display = 'none';
                    }
                }

                // Update AJAX handlers to render options
                function ajaxChatGet(handler, params) {
                    var url = window.location.pathname + '?handler=' + handler;
                    var query = '';
                    for (var key in params) {
                        if (query.length > 0) query += '&';
                        query += encodeURIComponent(key) + '=' + encodeURIComponent(params[key]);
                    }
                    if (query.length > 0) url += '&' + query;
                    fetch(url, {
                        method: 'GET',
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    })
                    .then(response => response.text())
                    .then(html => {
                        var parser = new DOMParser();
                        var doc = parser.parseFromString(html, 'text/html');
                        var newContent = doc.querySelector('#chatContent');
                        var options = doc.querySelector('.bot-options');
                        if (newContent) {
                            var chatBox = document.getElementById('chatBox');
                            var chatContents = chatBox.querySelectorAll('.chat-step');
                            if (chatContents.length > 0) {
                                chatContents[chatContents.length - 1].insertAdjacentHTML('afterend', '<div class="chat-step">'+newContent.innerHTML+'</div>');
                            } else {
                                chatBox.innerHTML = '<div class="chat-step">'+newContent.innerHTML+'</div>';
                            }
                            chatBox.scrollTop = chatBox.scrollHeight;
                        }
                        if (options) {
                            renderChatOptions(options.outerHTML);
                        } else {
                            renderChatOptions('');
                        }
                    });
                }

                function ajaxChatKeyword() {
                    var keyword = document.getElementById('KeywordInput').value;
                    if (!keyword) return;
                    var url = window.location.pathname + '?handler=EnterKeyword&Keyword=' + encodeURIComponent(keyword);
                    fetch(url, {
                        method: 'GET',
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    })
                    .then(response => response.text())
                    .then(html => {
                        var parser = new DOMParser();
                        var doc = parser.parseFromString(html, 'text/html');
                        var newContent = doc.querySelector('#chatContent');
                        var options = doc.querySelector('.bot-options');
                        if (newContent) {
                            var chatBox = document.getElementById('chatBox');
                            var chatContents = chatBox.querySelectorAll('.chat-step');
                            if (chatContents.length > 0) {
                                chatContents[chatContents.length - 1].insertAdjacentHTML('afterend', '<div class="chat-step">'+newContent.innerHTML+'</div>');
                            } else {
                                chatBox.innerHTML = '<div class="chat-step">'+newContent.innerHTML+'</div>';
                            }
                            chatBox.scrollTop = chatBox.scrollHeight;
                        }
                        if (options) {
                            renderChatOptions(options.outerHTML);
                        } else {
                            renderChatOptions('');
                        }
                    });
                }
        // AJAX GET for chat mode/options
        function ajaxChatGet(handler, params) {
            var url = window.location.pathname + '?handler=' + handler;
            var query = '';
            for (var key in params) {
                if (query.length > 0) query += '&';
                query += encodeURIComponent(key) + '=' + encodeURIComponent(params[key]);
            }
            if (query.length > 0) url += '&' + query;
            fetch(url, {
                method: 'GET',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => response.text())
            .then(html => {
                var parser = new DOMParser();
                var doc = parser.parseFromString(html, 'text/html');
                var newContent = doc.querySelector('#chatContent');
                if (newContent) {
                    var chatBox = document.getElementById('chatBox');
                    var chatContents = chatBox.querySelectorAll('.chat-step');
                    if (chatContents.length > 0) {
                        chatContents[chatContents.length - 1].insertAdjacentHTML('afterend', '<div class="chat-step">'+newContent.innerHTML+'</div>');
                    } else {
                        chatBox.innerHTML = '<div class="chat-step">'+newContent.innerHTML+'</div>';
                    }
                    chatBox.scrollTop = chatBox.scrollHeight;
                }
            });
        }

        function ajaxChatKeyword() {
            var keyword = document.getElementById('KeywordInput').value;
            if (!keyword) return;
            var url = window.location.pathname + '?handler=EnterKeyword&Keyword=' + encodeURIComponent(keyword);
            fetch(url, {
                method: 'GET',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => response.text())
            .then(html => {
                var parser = new DOMParser();
                var doc = parser.parseFromString(html, 'text/html');
                var newContent = doc.querySelector('#chatContent');
                if (newContent) {
                    var chatBox = document.getElementById('chatBox');
                    var chatContents = chatBox.querySelectorAll('.chat-step');
                    if (chatContents.length > 0) {
                        chatContents[chatContents.length - 1].insertAdjacentHTML('afterend', '<div class="chat-step">'+newContent.innerHTML+'</div>');
                    } else {
                        chatBox.innerHTML = '<div class="chat-step">'+newContent.innerHTML+'</div>';
                    }
                    chatBox.scrollTop = chatBox.scrollHeight;
                }
            });
        }
    function addUserBubble(text) {
        var chatContent = document.getElementById('chatContent');
        var bubble = document.createElement('div');
        bubble.className = 'chat-bubble user-bubble';
        bubble.textContent = text;
        chatContent.appendChild(bubble);
        chatContent.scrollTop = chatContent.scrollHeight;
    }
    function showStockGroupOptions() {
        // Bot message: ask for stock group
        var chatContent = document.getElementById('chatContent');
        var botMsg = document.createElement('div');
        botMsg.className = 'chat-bubble bot-bubble';
        // Fetch stock group items from backend via AJAX
        fetch(window.location.pathname + '?handler=GetStockGroups', {
            method: 'GET',
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.json())
        .then(stockGroups => {
            botMsg.innerHTML = '<strong>Bot:</strong> Please choose a category:<ol style="margin: 8px 0 0 24px;">' +
                stockGroups.map(function(item, idx) {
                    return '<li>' + item + '</li>';
                }).join('') + '</ol>';
            chatContent.appendChild(botMsg);
            chatContent.scrollTop = chatContent.scrollHeight;
            // Render buttons
            renderDynamicOptions(stockGroups, 'ChooseStockGroup', 'BackToSearchMode');
        });
    }
    document.addEventListener('DOMContentLoaded', function() {
        // Modal logic (unchanged)
        var openBtn = document.getElementById('openNewChatModal');
        var modal = document.getElementById('newChatModal');
        var cancelBtn = document.getElementById('cancelNewChat');
        var input = document.getElementById('NewChatTitle');
        var form = document.getElementById('newChatForm');
        openBtn.addEventListener('click', function() {
            modal.style.display = 'flex';
            setTimeout(function() { input.focus(); }, 100);
        });
        cancelBtn.addEventListener('click', function() {
            modal.style.display = 'none';
            input.value = '';
        });
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                modal.style.display = 'none';
                input.value = '';
            }
        });
        form.addEventListener('submit', function() {
            modal.style.display = 'none';
        });
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                modal.style.display = 'none';
                input.value = '';
            }
        });

        // AJAX chat logic
        function ajaxChatSubmit(form) {
            var handler = form.getAttribute('data-handler');
            var formData = new FormData(form);
            fetch(window.location.pathname + '?handler=' + handler, {
                method: 'POST',
                body: formData,
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => response.text())
            .then(html => {
                var parser = new DOMParser();
                var doc = parser.parseFromString(html, 'text/html');
                var newContent = doc.querySelector('#chatContent');
                if (newContent) {
                    document.getElementById('chatContent').innerHTML = newContent.innerHTML;
                    // Scroll chat up
                    var chatBox = document.getElementById('chatBox');
                    chatBox.scrollTop = 0;
                }
            });
        }

        // Attach AJAX submit to chat forms
        function attachChatAjax() {
            document.querySelectorAll('form[data-handler]').forEach(function(form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    ajaxChatSubmit(form);
                });
            });
        }
        attachChatAjax();

        // Re-attach AJAX after each update
        document.addEventListener('DOMSubtreeModified', function(e) {
            if (e.target.id === 'chatContent') {
                attachChatAjax();
            }
        });
    });
</script>
<style>
        #chatOptionsContainer {
            position: absolute;
            bottom: 32px;
            right: 32px;
            z-index: 100;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 16px #388e3c22;
            padding: 12px 16px;
            min-width: 200px;
            max-width: 320px;
            display: none;
            flex-direction: column;
            align-items: center;
        }
    .chat-layout { display: flex; max-width: 1100px; margin: 40px auto; }
    .bot-options { margin: 18px 0 0 0; display: flex; flex-wrap: wrap; gap: 10px; }
    .option-btn { background: #388e3c; color: #fff; border: none; border-radius: 4px; padding: 8px 18px; font-size: 1em; cursor: pointer; transition: background 0.2s; }
    .option-btn:hover { background: #2e7031; }
    .chat-sidebar { width: 220px; background: #f3f3f3; border-radius: 8px 0 0 8px; padding: 24px 16px; border: 1px solid #ccc; border-right: none; }
    .chat-sidebar h3 { margin-top: 0; }
    .chat-list { list-style: none; padding: 0; margin-bottom: 18px; }
    .chat-list li { margin-bottom: 10px; }
    .chat-list a { text-decoration: none; color: #1976d2; font-weight: 500; }
    .chat-list a:hover { text-decoration: underline; }
    .new-chat-form { display: flex; gap: 6px; }
    .new-chat-form input[type=text] { flex: 1; padding: 6px; border-radius: 4px; border: 1px solid #ccc; font-size: 1em; }
    .new-chat-form button { padding: 6px 14px; border-radius: 4px; border: none; background: #388e3c; color: #fff; font-size: 1em; }
    .chat-main { flex: 1; background: #fafafa; border-radius: 0 8px 8px 0; border: 1px solid #ccc; border-left: none; padding: 28px; }
    .chat-container { max-width: 700px; margin: 0 auto; }
    .chat-box {
        min-height: 400px;
        max-height: 500px;
        height: 500px;
        overflow-y: auto;
        margin-bottom: 18px;
        font-size: 1.15em;
        display: flex;
        flex-direction: column;
        resize: none;
    }
    .chat-step {
        background: #fff;
        border: 1.5px solid #388e3c;
        border-radius: 8px;
        margin: 18px 0 0 0;
        padding: 24px 18px;
        box-shadow: 0 2px 8px #388e3c22;
    }
    .user-msg { text-align: right; color: #1976d2; margin-bottom: 10px; }
    .bot-msg { text-align: left; color: #388e3c; margin-bottom: 10px; }
    .chat-form { display: flex; gap: 10px; }
    .chat-form input[type=text] { flex: 1; padding: 10px; border-radius: 4px; border: 1px solid #ccc; font-size: 1em; }
    .chat-form button { padding: 10px 24px; border-radius: 4px; border: none; background: #1976d2; color: #fff; font-size: 1em; }
    .chat-tabs-bar {
        background: #f3f3f3;
        border-radius: 8px 8px 0 0;
        padding: 0 0 0 8px;
    }
    .chat-tab {
        border-bottom: 2.5px solid transparent;
        background: none;
        font-size: 1em;
        cursor: pointer;
        border-radius: 8px 8px 0 0;
        margin-right: 2px;
        font-weight: 500;
        outline: none;
        transition: background 0.2s, border-bottom 0.2s;
    }
    .chat-tab.active, .chat-tab:focus {
        background: #fff;
        border-bottom: 2.5px solid #388e3c;
        color: #388e3c;
    }
    .new-chat-btn {
        margin-left: 8px;
        font-size: 1.3em;
        background: #388e3c;
        color: #fff;
        border: none;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
    }
    .new-chat-btn:hover {
        background: #2e7031;
    }
    .chat-bubble {
        max-width: 70%;
        padding: 10px 16px;
        margin: 8px 0;
        border-radius: 18px;
        font-size: 1rem;
        display: inline-block;
        clear: both;
        word-break: break-word;
        box-shadow: 0 1px 2px rgba(0,0,0,0.07);
    }
    .user-bubble {
        background: #0078fe;
        color: #fff;
        float: right;
        border-bottom-right-radius: 4px;
        border-bottom-left-radius: 18px;
        border-top-left-radius: 18px;
        border-top-right-radius: 18px;
        text-align: right;
    }
    .bot-bubble {
        background: #f1f0f0;
        color: #222;
        float: left;
        border-bottom-left-radius: 4px;
        border-bottom-right-radius: 18px;
        border-top-left-radius: 18px;
        border-top-right-radius: 18px;
        text-align: left;
    }
    .chat-list {
        background: transparent;
        box-shadow: none;
        padding: 0 0 0 24px;
        margin: 0;
        list-style: disc inside;
    }
    #chatContent::after {
        content: "";
        display: block;
        clear: both;
    }
</style>

// ...dynamicOptions div below chat removed...
